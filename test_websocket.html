<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .message { margin: 5px 0; padding: 5px; border: 1px solid #ccc; }
        .transfer { background-color: #e8f5e8; }
        .chart { background-color: #e8e8f5; }
        .error { background-color: #f5e8e8; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Connecting...</div>
    <div id="stats">
        <h3>Connection Stats:</h3>
        <div>Messages received: <span id="messageCount">0</span></div>
        <div>Transfers received: <span id="transferCount">0</span></div>
        <div>Chart updates: <span id="chartCount">0</span></div>
    </div>
    
    <h3>Recent Messages:</h3>
    <div id="messages"></div>

    <script>
        let messageCount = 0;
        let transferCount = 0;
        let chartCount = 0;
        
        const status = document.getElementById('status');
        const messages = document.getElementById('messages');
        
        function updateStats() {
            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('transferCount').textContent = transferCount;
            document.getElementById('chartCount').textContent = chartCount;
        }
        
        function addMessage(type, data) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}] ${type.toUpperCase()}</strong><br>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            messages.insertBefore(div, messages.firstChild);
            
            // Keep only last 10 messages
            while (messages.children.length > 10) {
                messages.removeChild(messages.lastChild);
            }
        }
        
        // Connect to WebSocket
        const ws = new WebSocket('ws://localhost:8080/ws');
        
        ws.onopen = function() {
            status.textContent = 'Connected ✅';
            status.style.color = 'green';
            addMessage('connection', { status: 'connected' });
        };
        
        ws.onmessage = function(event) {
            messageCount++;
            
            try {
                const message = JSON.parse(event.data);
                
                if (message.type === 'transfers') {
                    transferCount++;
                    addMessage('transfer', {
                        type: message.type,
                        transferCount: message.data ? message.data.length : 0,
                        sampleTransfer: message.data && message.data[0] ? {
                            packet_hash: message.data[0].packet_hash,
                            source_chain: message.data[0].source_chain,
                            destination_chain: message.data[0].destination_chain,
                            senderDisplay: message.data[0].senderDisplay,
                            receiverDisplay: message.data[0].receiverDisplay
                        } : null
                    });
                } else if (message.type === 'chartData') {
                    chartCount++;
                    addMessage('chart', {
                        type: message.type,
                        hasCurrentRates: message.data && message.data.currentRates ? true : false,
                        hasActiveWalletRates: message.data && message.data.activeWalletRates ? true : false
                    });
                } else {
                    addMessage('other', message);
                }
            } catch (e) {
                addMessage('error', { error: 'Failed to parse JSON', raw: event.data });
            }
            
            updateStats();
        };
        
        ws.onerror = function(error) {
            status.textContent = 'Error ❌';
            status.style.color = 'red';
            addMessage('error', { error: error.toString() });
        };
        
        ws.onclose = function() {
            status.textContent = 'Disconnected ❌';
            status.style.color = 'red';
            addMessage('connection', { status: 'disconnected' });
        };
    </script>
</body>
</html> 